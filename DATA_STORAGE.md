# Data Storage Overview

## What Data is Stored?

This document outlines all the data currently stored in the browser's localStorage and how it maps to the server storage system.

## 1. User Accounts

**localStorage key**: `learn_copilot_users`

**Server file**: `server/storage/users.json`

**Structure**:
```typescript
{
  id: string;           // e.g., "user-1642345678"
  username: string;     // e.g., "john_doe"
  password: string;     // Plain password (SHOULD BE HASHED in production)
  avatar: string | null;
  createdAt: string;    // ISO timestamp
}[]
```

**Data Type**: Global user registry

---

## 2. Knowledge Bases (Learning Materials)

**localStorage key**: `learn_copilot_data_{userId}`

**Server file**: `server/storage/user-{userId}/knowledge_bases.json`

**Structure**:
```typescript
{
  id: string;                    // Unique KB identifier
  title: string;                 // e.g., "React 基础"
  description: string;           // Topic description
  tag: string;                   // e.g., "Frontend", "Backend"
  progress: number;              // 0-100%
  status: string;                // "进行中", "已完成", "待开始"
  lastUpdated: string;           // Date string
  files: KnowledgeFile[];        // Uploaded/added files
  graphData: GraphData;          // Knowledge graph nodes & edges
  learningPath: LearningPathData; // Structured learning modules
}[]
```

**Data Type**: Per-user collection

---

## 3. Knowledge Files

**Embedded in**: Knowledge Base object

**Structure**:
```typescript
{
  id: string;           // File ID
  name: string;         // e.g., "React_基础.md"
  type: string;         // "md", "pdf", "txt", etc.
  size: string;         // e.g., "2.5 KB"
  date: string;         // Upload date
  content: string;      // Full file content
}[]
```

---

## 4. Knowledge Graph

**Embedded in**: Knowledge Base object

**Structure**:
```typescript
{
  topic: string;        // e.g., "React 基础知识"
  nodes: GraphNode[];   // Concepts and facts
  edges: GraphEdge[];   // Relationships between nodes
}

// Node
{
  id: string;           // e.g., "n1"
  label: string;        // e.g., "React"
  type: string;         // "concept", "fact", "example"
  x: number;            // Canvas X position
  y: number;            // Canvas Y position
}

// Edge
{
  source: string;       // Source node ID
  target: string;       // Target node ID
  label: string;        // Relationship description
}
```

---

## 5. Learning Path

**Embedded in**: Knowledge Base object

**Structure**:
```typescript
{
  modules: LearningModule[];

  // Module
  {
    id: string;               // Module ID
    title: string;            // e.g., "核心架构"
    description: string;      // What you'll learn
    nodeIds: string[];        // IDs of relevant graph nodes
    status: string;           // "completed", "active", "not-started"
  }[]
}
```

---

## 6. Assessment Results (SRS - Spaced Repetition System)

**localStorage key**: `learn_copilot_results_{userId}`

**Server file**: `server/storage/user-{userId}/assessment_results.json`

**Structure**:
```typescript
{
  nodeId: string;           // Knowledge node being assessed
  score: number;            // 0-100
  interval: number;         // Days until next review
  repetition: number;       // How many times reviewed
  nextReviewDate: number;   // Timestamp for next review
  timestamp: number;        // When this was recorded
}[]
```

**Purpose**: Tracks SRS intervals for spaced repetition learning. One entry per node (latest result only).

---

## 7. Assessment History

**localStorage key**: `learn_copilot_history_{userId}`

**Server file**: `server/storage/user-{userId}/assessment_history.json`

**Structure**:
```typescript
{
  nodeId: string;           // Knowledge node
  score: number;            // 0-100
  timestamp: number;        // When assessed
}[]
```

**Purpose**: Complete audit log of all assessments. Used for analytics and progress tracking.

---

## 8. AI Learning Insights

**localStorage key**: `learn_copilot_insights_{userId}`

**Server file**: `server/storage/user-{userId}/ai_insights.json`

**Structure**:
```typescript
{
  speed: string;            // Comment on learning pace (30-40 words)
  recommendation: string;   // Actionable study recommendation (30-40 words)
  timestamp: number;        // When generated
}
```

**Purpose**: Generated by AI after analyzing user's learning patterns. Personalized feedback.

---

## 9. Model Configuration

**localStorage key**: `learn_copilot_model_config`

**Server file**: `server/storage/model_config.json`

**Structure**:
```typescript
{
  modelName: string;        // e.g., "gemini-3-flash-preview"
  baseUrl?: string;         // Custom API endpoint (optional)
  apiKey?: string;          // User's API key (optional)
  corsProxy?: string;       // CORS proxy URL (optional)
}
```

**Purpose**: Global configuration for AI model. Shared across all users/sessions.

---

## 10. Custom Prompts Configuration

**localStorage key**: `learn_copilot_prompts_config`

**Server file**: `server/storage/prompts_config.json`

**Structure**:
```typescript
{
  generate_graph: string;       // Prompt for knowledge graph generation
  chat_with_graph: string;      // Prompt for graph-based Q&A
  generate_question: string;    // Prompt for test question generation
  evaluate_answer: string;      // Prompt for answer evaluation
  generate_path: string;        // Prompt for learning path generation
  analytics_insights: string;   // Prompt for learning insights
}
```

**Purpose**: Allows customization of AI prompts without code changes.

---

## Data Flow Diagram

```
Frontend (React)
    ↓ (User Actions)
    ├─→ utils/storage.ts (localStorage)
    │   └─→ Browser Storage
    └─→ utils/server-sync.ts (HTTP)
        └─→ Server (Node.js/Express)
            └─→ server/storage/ (File System)
```

## Migration Checklist

When moving from localStorage to server storage:

- [ ] Start backend server: `npm run server`
- [ ] Install dependencies: `npm install`
- [ ] Set `REACT_APP_SERVER_URL` environment variable (optional)
- [ ] Sync existing localStorage data to server
- [ ] Update components to use `server-sync.ts` functions
- [ ] Test offline fallback (disable server, verify localStorage works)
- [ ] Test online sync (server running, verify data persists)

## Notes

- All data is stored as **JSON files** (not a traditional database)
- Storage is **per-user** (except global configs)
- **No encryption** at rest (implement for production)
- **No database transactions** (implement for production if needed)
- **Backup/restore** supported via API endpoints
